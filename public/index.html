<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eat Safe</title>

  <!-- We'll set this href via JS so it works on GitHub Pages subpaths -->
  <link rel="icon" type="image/jpeg" id="fav" href="">
  <meta name="theme-color" content="#d7263d" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff; --text:#111111; --muted:#5b6470; --accent:#d7263d;
      --card:#ffffff; --border:#e9eef4; --shadow:0 6px 18px rgba(17,17,17,0.05);
      --ok:#12b981; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui;padding-bottom:56px}
    .wrap{max-width:960px;margin:40px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px;flex-wrap:wrap}
    .logo-img{width:40px;height:40px;border-radius:10px;box-shadow:var(--shadow);object-fit:cover}
    h1{font-weight:800;margin:0;color:var(--accent)}
    .credit{font-size:12px;color:var(--muted);margin-top:4px}
    .credit strong{color:var(--accent)}
    p.sub{color:var(--muted);margin:6px 0 20px}

    .searchbar{display:flex;gap:10px;align-items:center;position:sticky;top:0;background:var(--bg);padding:8px 0;z-index:2}
    .searchbar input{flex:1;padding:14px 16px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--text);box-shadow:var(--shadow)}
    .btn{background:#fff;color:var(--accent);border:1px solid var(--accent);border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn:hover{background:var(--accent);color:#fff}

    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px;border:1px solid transparent}
    .b-ok{background:color-mix(in srgb, var(--ok) 14%, white); color:var(--ok); border-color:color-mix(in srgb, var(--ok) 40%, white)}
    .b-warn{background:color-mix(in srgb, var(--warn) 14%, white); color:var(--warn); border-color:color-mix(in srgb, var(--warn) 40%, white)}
    .b-bad{background:color-mix(in srgb, var(--bad) 14%, white); color:var(--bad); border-color:color-mix(in srgb, var(--bad) 40%, white)}

    .list{margin-top:20px;display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 8px}
    .meta{color:var(--muted);font-size:14px}
    .row{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-top:10px;flex-wrap:wrap}
    .history{margin-top:10px;border-top:1px solid var(--border);padding-top:10px}
    .empty{color:var(--muted);margin-top:20px}

    /* sticky footer pinned to bottom */
    .site-footer{
      position: fixed; left: 0; right: 0; bottom: 0;
      background: var(--bg); border-top: 1px solid var(--border);
      z-index: 50; padding: 6px 0; box-shadow: 0 -4px 14px rgba(17,17,17,0.04);
    }
    .site-footer .wrap{ max-width:960px; margin:0 auto; padding:0 16px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <img class="logo-img" id="logo" alt="Eat Safe logo">
      <div>
        <h1>Eat Safe</h1>
        <p class="sub">Search by restaurant or address in Toronto. See the <strong>latest inspection</strong> and open the history with details.</p>
      </div>
    </header>

    <div class="searchbar">
      <input id="q" type="text" placeholder="Try “MOEGI SUSHI” or “123 King St”" autofocus />
      <button id="clearBtn" class="btn" title="Clear search">Clear</button>
    </div>

    <div id="results" class="list"></div>
    <div id="empty" class="empty" style="display:none">No matches yet. Start typing above.</div>
  </div>

  <footer class="site-footer">
    <div class="wrap">
      <div class="credit">© <strong>2025</strong> Made by <strong>Jason Xie</strong> — Built with HTML, CSS, JavaScript (PapaParse), SQLite, and Python (pandas)</div>
    </div>
  </footer>

  <script>
    // Build absolute URLs relative to the current page (works on localhost and /eat-safe/ on GitHub Pages)
    const csvUrl  = new URL("data/inspections.csv", window.location.href).toString() + "?v=" + Date.now();
    const logoUrl = new URL("icons/eat-safe-fork-solid-128.jpg", window.location.href).toString();

    // Set logo + favicon paths safely for both environments
    document.getElementById("logo").src = logoUrl;
    document.getElementById("fav").href = logoUrl;

    let rows = [];
    let latestByPlace = [];

    function badgeClass(outcome){
      const o = (outcome||"").toLowerCase();
      if (o.includes("pass")) return "badge b-ok";
      if (o.includes("cond")) return "badge b-warn";
      if (o.includes("fail") || o.includes("closed") || o.includes("hazard")) return "badge b-bad";
      return "badge";
    }
    const norm = s => (s||"").toString().toLowerCase().normalize("NFKD").replace(/[\u0300-\u036f]/g,"");

    function buildLatest(){
      const map = new Map();
      for(const r of rows){
        const key = norm(r.name)+"|"+norm(r.address);
        const d = Date.parse(r.inspection_date || "");
        if(!map.has(key) || d > map.get(key)._ts){ map.set(key, {...r, _ts: isNaN(d)? -Infinity : d}); }
      }
      latestByPlace = [...map.values()].sort((a,b)=>b._ts-a._ts);
    }

    function render(list){
      const el = document.getElementById("results");
      const empty = document.getElementById("empty");
      el.innerHTML = "";
      if(!list.length){ empty.style.display="block"; return; }
      empty.style.display="none";

      for(const r of list.slice(0, 50)){
        const when = (r.inspection_date || "").slice(0,10);
        const details = [];
        if (r.code)      details.push(`Code: ${r.code}`);
        if (r.violation) details.push(r.violation);
        if (r.action)    details.push(r.action);
        if (r.severity)  details.push(r.severity);
        const detail = details.join(" — ");
        const key = norm(r.name)+"|"+norm(r.address);

        el.insertAdjacentHTML("beforeend", `
          <div class="card">
            <h3>${r.name||"(unknown)"} <span class="${badgeClass(r.result)}">${r.result||"—"}</span></h3>
            <div class="meta">${r.address||""}</div>
            ${detail ? `<div class="meta" style="margin-top:6px">${detail}</div>` : ""}
            <div class="row">
              <div class="meta">Last inspected: <strong>${when || "—"}</strong></div>
              <button class="btn" data-key="${key}">View history</button>
            </div>
            <div class="history" style="display:none"></div>
          </div>
        `);
      }

      // history toggles
      el.querySelectorAll("button[data-key]").forEach(btn=>{
        btn.onclick = () => {
          const key = btn.getAttribute("data-key");
          const card = btn.closest(".card");
          const target = card.querySelector(".history");
          if(target.style.display==="none"){
            const hist = rows
              .filter(x => norm(x.name)+"|"+norm(x.address) === key)
              .sort((a,b)=> Date.parse(b.inspection_date||"") - Date.parse(a.inspection_date||""));
            target.innerHTML = hist.map(h => {
              const bits = [];
              if (h.code)      bits.push(`Code: ${h.code}`);
              if (h.violation) bits.push(h.violation);
              if (h.action)    bits.push(h.action);
              if (h.severity)  bits.push(h.severity);
              const dline = bits.join(" — ");
              return `<div class="meta">• ${(h.inspection_date||"").slice(0,10)} — <strong>${h.result||"—"}</strong>${dline ? " — " + dline : ""}</div>`;
            }).join("") || "<div class='meta'>No history found.</div>";
            target.style.display = "block";
            btn.textContent = "Hide history";
          } else {
            target.style.display = "none";
            btn.textContent = "View history";
          }
        };
      });
    }

    // Load CSV with Papa; add tiny diagnostics to help if something breaks on Pages
    window.addEventListener("load", () => {
      console.log("CSV URL:", csvUrl);
      fetch(csvUrl, { method: "HEAD", cache: "no-store" })
        .then(r => console.log("CSV HEAD:", r.status, r.headers.get("content-length")))
        .catch(e => console.warn("CSV HEAD failed:", e));

      Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        worker: true,
        complete: (res) => {
          console.log("Papa complete; errors:", res.errors);
          rows = res.data.map(r => ({
            name:  r.name || r["Establishment Name"],
            address: r.address || r["Establishment Address"],
            inspection_date: (r.inspection_date || r["Inspection Date"] || "").toString(),
            result: r.result || r["Outcome"],
            violation: r.violation || r["Infraction Details"] || r["Details"] || "",
            action: r.action || r["Action"] || r["Notice"] || "",
            severity: r.severity || r["Severity"] || r["Severity Category"] || "",
            code: r.code || r["Infraction Code"] || r["InfractionCode"] || r["Code"] || ""
          })).filter(r => r.name && r.address);

          console.log("Loaded rows:", rows.length);
          buildLatest();

          const urlQ = new URL(location).searchParams.get("q") || "";
          if(urlQ){ document.getElementById("q").value = urlQ; doSearch(urlQ); }
          else { render([]); }

          if (!rows.length) {
            const e = document.getElementById("empty");
            e.textContent = "No data loaded. Check that data/inspections.csv is published.";
            e.style.display = "block";
          }
        },
        error: (err) => {
          console.error("Papa error:", err);
          const e = document.getElementById("empty");
          e.textContent = "Failed to load CSV: " + csvUrl;
          e.style.display = "block";
        }
      });
    });

    function doSearch(q){
      q = norm(q);
      if(!q){ render([]); return; }
      const out = latestByPlace.filter(r =>
        norm(r.name).includes(q) || norm(r.address).includes(q)
      );
      render(out);
    }

    document.getElementById("q").addEventListener("input", e => doSearch(e.target.value));
    document.getElementById("clearBtn").onclick = () => { document.getElementById("q").value=""; render([]); };
  </script>
</body>
</html>
